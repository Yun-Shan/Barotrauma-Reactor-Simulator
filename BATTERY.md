# 电池稳压电路笔记

需要注意：
- 电池的充电功率会被四舍五入到10%的倍数
- 由于继电组件会[强行平滑负载](https://github.com/Regalis11/Barotrauma/blob/a122e54c729a9ea77b52721edf2ba15aea2e8774/Barotrauma/BarotraumaShared/SharedSource/Items/Components/Signal/RelayComponent.cs#L164-L180)，电池如果通过继电器输出，当实际负载跳变时电池的输出实际上会被平滑变化(导致测量负载不等于实际负载)，通过继电器输入同理，充电速率跳变时反应堆仍然会得到平滑后的负载。  
  因此当接入继电组件时，部分计算变量应当按需改为继电组件的输出。

```text
过压保护时：电池输出断开电网，充电按需跳变
欠压保护时：电池输出连接电网，充电为0
```


```text

智能计算裂变模块的目标功率：
过压保护时：目标功率 = 反应堆负载 - 电池充电功率 = 除去电池充电外的实际负载
其它时候：目标功率 = 反应堆负载


欠压保护由游戏机制自动实现，无需管理 // TODO 是否会导致反应堆功率曲线到不了顶峰

过压保护：
若 反应堆当前输出功率 > 反应堆负载
则 充电功率 = 反应堆当前输出功率 - 反应堆负载 - 当前充电功率

蓄电保障
若 反应堆信号输出负载 < 反应堆功率最大值 且 蓄电比例 < 预设比例
则 充电功率 = 当前充电功率 + min(反应堆功率最大值 - 反应堆信号输出负载, 0.1 * 反应堆功率最大值)
这里确保充电功率导致的负载功率变化不超过反应堆最大功率的10%，这样反应堆可以迅速反应过来，以减少负载增加导致欠压的影响

当上述两者都不满足时，充电功率 = 0

充电速率 = (max(过压保护充电功率, 蓄电保障充电功率) / 充电功率最大值) * 100
```

```text
max模块：
大于组件：
    信号1 a
    信号2 b
    输出  1
    假输出 0
NOT组件：
    输入 大于的输出
继电器1：
    信号1 a
    状态设置 大于的输出
继电器2：
    信号1 b
    状态设置 NOT的输出
2个继电器的信号输出连接到同一个接口

min模块：
    大于组件的输出和假输出的值互换
```
