# 电池稳压电路笔记

需要注意：
- 电池的充电功率会被四舍五入到10%的倍数
- 由于继电组件会[强行平滑负载](https://github.com/Regalis11/Barotrauma/blob/a122e54c729a9ea77b52721edf2ba15aea2e8774/Barotrauma/BarotraumaShared/SharedSource/Items/Components/Signal/RelayComponent.cs#L164-L180)，电池如果通过继电器输出，当实际负载跳变时电池的输出实际上会被平滑变化(导致测量负载不等于实际负载)，通过继电器输入同理，充电速率跳变时反应堆仍然会得到平滑后的负载。  
  因此当接入继电组件时，部分计算变量应当按需改为继电组件的输出，并且要考虑假负载问题(无其它用电器，电池通过继电器输入，充电速率从非0跳变到0，反应堆会有一段短暂的时间仍然收到负载需求)

```text
过压保护时：电池输出断开电网，充电按需跳变
欠压保护时：电池输出连接电网，充电为0
```


```text
反应堆功率 = 反应堆的功率信号
反应堆负载 = 反应堆的负载信号
当前充电百分比 = 电池的充能百分比信号
电池的需求充电功率 = 充电速率 * 预设充电功率最大值
电网的需求充电功率 = if (通过继电组件充电) 继电组件负载信号 else 电池的需求充电功率
电池的放电功率 = 电池的功率信号
电网的放电功率 = if (通过继电组件放电) 继电组件功率信号 else 电池的放电功率
预设充电百分比 = 70(过压通常反应堆能快速下降避免过压，但欠压可能是用电量超出反应堆最大功率，所以需要保留更多电量应对欠压)

分情况讨论：
电池功率差 = 反应堆功率 - (反应堆负载 - 电池的需求充电功率)
电网功率差 = 反应堆功率 - (反应堆负载 - 电网的需求充电功率)
if 电池功率差 > 0 ：
可以推定充电功率一定是太低导致的过压因此需要调高充电功率以完成过压保护：
设置充电速率：反应堆功率 - 反应堆负载 - 电池的需求充电功率
此时不考虑电池的电量百分比，因为无论剩余电量是多少都得有那么高的充电功率。为了使逻辑简单也不去考虑充电效率是否足够
需要注意：电池充电速率调低也会造成短暂的过压，

else if 电网功率差 < 0：
此时是欠压状态，将充电功率设为0以避免占用放电功率。注意这里用的是电网
else ：
此时是均衡状态


反应堆功率 > (反应堆负载 - 电网的需求充电功率)   当前充电百分比 < 预设充电百分比     设置充电百分比
          √                                                ×                   反应堆功率 - (反应堆负载 - 电网的需求充电功率)
          √                                                √
          ×                                                ×
          ×                                                √  



智能计算裂变模块的目标功率：
过压保护时：目标功率 = 反应堆负载 - 电池充电功率 = 除去电池充电外的实际负载
其它时候：目标功率 = 反应堆负载


欠压保护由游戏机制自动实现，无需管理 // TODO 是否会导致反应堆功率曲线到不了顶峰

过压保护：
若 反应堆当前输出功率 > 反应堆负载
则 充电功率 = 反应堆当前输出功率 - 反应堆负载 - 当前充电功率

蓄电保障
若 反应堆信号输出负载 < 反应堆功率最大值 且 蓄电比例 < 预设比例
则 充电功率 = 当前充电功率 + min(反应堆功率最大值 - 反应堆信号输出负载, 0.1 * 反应堆功率最大值)
这里确保充电功率导致的负载功率变化不超过反应堆最大功率的10%，这样反应堆可以迅速反应过来，以减少负载增加导致欠压的影响

当上述两者都不满足时，充电功率 = 0

充电速率 = (max(过压保护充电功率, 蓄电保障充电功率) / 充电功率最大值) * 100
```

```text
max模块：
大于组件：
    信号1 a
    信号2 b
    输出  1
    假输出 0
信号检查组件1：
    目标：1
    设置输出：a
信号检查组件2：
    目标：0
    设置输出：b
2个信号检查组件的输出连接到同一个接口

min模块：
    大于组件的输出和假输出的值互换
```
