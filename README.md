# 潜渊症 反应堆模拟器

仅用于模拟线控反应堆，不考虑玩家和AI操控的情况。
模拟代码中剔除了AI相关和玩家相关操作的变量和逻辑。
实际反应堆有一个容差设定，会使得实际可输出功率为理论公式精确值上下增加1%或3%。
实际反应堆需要持续线控信号才能成功设置涡轮速率和裂变速率，脉冲信号是无效的，这里不判断信号的有效性，默认有持续收到信号。
连接到友好的前哨站时不消耗燃料耐久，这里不考虑，固定会消耗燃料。
多反应堆时的负载和功率分配略微复杂，这里只考虑单反应堆。


一些公式：
```text
功率最大值 = 引擎基础功率(不可变) + 引擎升级 + 工程师技能加成
燃料消耗率 = 反应堆设定燃料消耗率(不可变)

每秒燃料消耗速度 = (燃料消耗率 * 裂变速率) / 100
燃料可用时间(秒) = (燃料消耗速度 * 100）/ 燃料消耗率 * 裂变速率

裂变速率、涡轮输出 => 可通过反应堆线控设置，但需要注意实际生效需要一定时间
当前负载 => 可通过反应堆线控获取(如果包含电池稳压电路，则要减去充电负载)

当前温度是内部计算用的温度，反应堆信号输出的温度 = 当前温度 * 100
温度因数 = min(当前温度 / 50, 1)
输出功率 = 功率最大值 * clamp(min((涡轮输出 ± 容差) / 100, 温度因数), 0, 1)

产生热量 = 裂变速率 * (燃料总热势 / 100) * 2 = (裂变速率 * 燃料总热势) / 50
目标温度 = 产生热量 - 涡轮输出


当需要满足负载功率，应满足 (涡轮输出 + 容差) / 100 >= min(负载 / 功率最大值, 1)


如果要最省油 则：
(涡轮输出 + 容差) / 100 = min(负载 / 功率最大值, 1) = 温度因数
=> (涡轮输出 + 容差) / 100 = 温度因数 = min(当前温度 / 50, 1)
设温度不超过50：
(涡轮输出 + 容差) / 100 = 当前温度 / 50
=> 当前温度 = (涡轮输出 + 容差) / 2
将上述关系式代入目标温度公式可以得到当满足以下式子时燃料消耗速度最低：
涡轮输出 + 容差 = (裂变速率 * 燃料总热势) / 75
=> 裂变速率 = (75 * (涡轮输出 + 容差)) / 燃料总热势
而涡轮输出可根据负载关系式得到：
涡轮输出 = 100 * min(负载 / 功率最大值, 1) - 容差


高性能模式下：
纯裂变速率控制温度达到输出功率控制，涡轮输出固定为100 - 0.9
(因为至少有1的容差，99就能达到100的效果，不用99整的原因是他的算法实际上达不到设定值，只能无限接近)
此时输出功率仅由温度控制：
输出功率 = 功率最大值 * min(当前温度 / 50, 1) 
目标温度 = 产生热量 - 涡轮输出 = (裂变速率 * 燃料总热势) / 50 - 100
目标功率所需温度 = min((目标功率 / 功率最大值) * 50, 50)
由于温度每秒最多变化1000度(内部计算值为10)，为了让温度能够保持最大速率变化，应满足 |目标温度 - 当前温度| >= 10，可得：
|((裂变速率 * 燃料总热势) / 50 - 100) - 当前温度| = 10
化简得：
若需要每秒增加1000度：调节用的裂变速率 = (50 * 当前温度 + 5500) / 燃料总热势
若需要每秒减少1000度：调节用的裂变速率 = (50 * 当前温度 + 4500) / 燃料总热势

真实需要的裂变速率 = 功率最大值 * (((真实需要的裂变速率 * 燃料总热势) / 50 - 100) / 50)
目标温度 = (真实需要的裂变速率 * 燃料总热势) / 50 - 100
化简得：
真实需要的裂变速率 = (-2 * 功率最大值) / (-0.0004 * 燃料总热势 * 功率最大值 + 1)
真实需要的裂变速率 = (50 * 目标温度 + 5000) / 燃料总热势

若 |当前温度 - 目标功率所需温度| < |测得温度变化量| * 7，或者 当前温度 >= 5000，
则认为调节完毕，使用 真实需要的裂变速率，否则使用 调节用的裂变速率。
其中 7 是一个魔法数字，含义是温度经过7游戏刻的变化量，通过这个扩大变化量以避免反复波动切换调节/目标裂变。
游戏内可通过乘法组件限制 |测得温度变化量| * 7 的值来实现限制范围。
可根据实际情况调大或调小 7 这个魔法值，值越大意味着在接近目标温度的时候变化越慢，值越小则越快，但过小的值可能导致变化过快直接跳过目标温度导致温度/功率反复横跳

由于游戏中信号输出的温度是乘100的，所以游戏中获取温度需要增加一步：
当前温度 = 信号输出温度 / 100
测得温度变化量 = 测得温度变化量 / 100
若测得 当前温度 = 5000，且涡轮输出已经调整了足够长的时间确定已经变成100，且对接舱口未连接站点，则可得：功率最大值 = 当前功率
```
